name: Deploy Staging

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  NODE_VERSION: 24
  PNPM_VERSION: 10
  GCP_REGION: europe-west9
  GCP_PROJECT: gotloop
  REGISTRY: europe-west9-docker.pkg.dev/gotloop/gotloop

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install infra dependencies
        run: cd infra && pnpm install --frozen-lockfile

      - name: Set SHAs for affected detection
        uses: nrwl/nx-set-shas@v4

      - name: Determine affected apps
        id: affected
        run: |
          AFFECTED=$(pnpm exec nx show projects --affected --type=app | tr '\n' ' ')
          echo "apps=$AFFECTED" >> "$GITHUB_OUTPUT"
          echo "Affected apps: $AFFECTED"
          if [ -z "$AFFECTED" ]; then
            echo "No apps affected, skipping deployment"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Docker Buildx
        if: steps.affected.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3

      - name: Set image tag
        id: tag
        run: |
          SHA7=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          echo "sha7=$SHA7" >> "$GITHUB_OUTPUT"
          echo "tag=pr-${{ github.event.pull_request.number }}-$SHA7" >> "$GITHUB_OUTPUT"

      - name: Build and push API image
        if: contains(steps.affected.outputs.apps, 'api')
        uses: docker/build-push-action@v6
        with:
          context: .
          target: api
          push: true
          tags: ${{ env.REGISTRY }}/api:${{ steps.tag.outputs.tag }}
          build-args: NODE_VERSION=${{ env.NODE_VERSION }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

      - name: Build and push WWW image
        if: contains(steps.affected.outputs.apps, 'www')
        uses: docker/build-push-action@v6
        with:
          context: .
          target: www
          push: true
          tags: ${{ env.REGISTRY }}/www:${{ steps.tag.outputs.tag }}
          build-args: NODE_VERSION=${{ env.NODE_VERSION }}
          cache-from: type=gha,scope=www
          cache-to: type=gha,mode=max,scope=www

      - name: Build and push ADM image
        if: contains(steps.affected.outputs.apps, 'adm')
        uses: docker/build-push-action@v6
        with:
          context: .
          target: adm
          push: true
          tags: ${{ env.REGISTRY }}/adm:${{ steps.tag.outputs.tag }}
          build-args: NODE_VERSION=${{ env.NODE_VERSION }}
          cache-from: type=gha,scope=adm
          cache-to: type=gha,mode=max,scope=adm

      - name: Deploy staging with Pulumi
        if: steps.affected.outputs.skip != 'true'
        id: pulumi
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: staging-pr-${{ github.event.pull_request.number }}
          upsert: true
          work-dir: infra
          config-map: |
            {
              "gotloop:imageTag": { "value": "${{ steps.tag.outputs.tag }}" },
              "gotloop:commitSha": { "value": "${{ github.event.pull_request.head.sha }}" },
              "gotloop:environment": { "value": "staging" },
              "gotloop:domain": { "value": "gotloop.io" },
              "gcp:project": { "value": "gotloop" },
              "gcp:region": { "value": "europe-west9" }
            }
        env:
          PULUMI_BACKEND_URL: ${{ secrets.PULUMI_BACKEND_URL }}

      - name: Post staging URLs to PR
        if: steps.affected.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            const tag = '${{ steps.tag.outputs.tag }}';
            const outputs = JSON.parse('${{ steps.pulumi.outputs.output }}' || '{}');
            const wwwUrl = outputs.wwwUrl || '(pending)';
            const apiUrl = outputs.apiUrl || '(pending)';
            const body = `## Staging Deployment

            | Service | URL |
            |---------|-----|
            | WWW | ${wwwUrl} |
            | API | ${apiUrl} |

            > Commit: \`${{ github.event.pull_request.head.sha }}\`
            > Image tag: \`${tag}\`
            > Stack: \`staging-pr-${prNumber}\``;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## Staging Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
